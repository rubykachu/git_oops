#!/usr/bin/env bash

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Starting release process...${NC}"

# Check if working directory is clean
if [[ -n $(git status -s) ]]; then
  echo "Error: Working directory is not clean. Please commit all changes first."
  exit 1
fi

# Build and test
echo -e "\n${GREEN}Running tests...${NC}"
bundle exec rake spec

# Build gem
echo -e "\n${GREEN}Building gem...${NC}"
gem build git_oops.gemspec

# Get version from version.rb
VERSION=$(ruby -r "./lib/git_oops/version.rb" -e "puts GitOops::VERSION")

# Create git tag
echo -e "\n${GREEN}Creating git tag v${VERSION}...${NC}"
git tag -a "v${VERSION}" -m "Release version ${VERSION}"
git push origin "v${VERSION}"

# Publish to RubyGems
echo -e "\n${GREEN}Publishing to RubyGems...${NC}"
gem push "git_oops-${VERSION}.gem"

# Cleanup
echo -e "\n${GREEN}Cleaning up...${NC}"
rm "git_oops-${VERSION}.gem"

echo -e "\n${GREEN}Release v${VERSION} completed successfully!${NC}"
