#!/usr/bin/env bash

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --otp)
      OTP_CODE="$2"
      shift 2
      ;;
    --force)
      FORCE=true
      shift
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}"
      exit 1
      ;;
  esac
done

echo -e "${YELLOW}Starting first release process...${NC}"

# Clean up any existing gem files
echo -e "\n${GREEN}Cleaning up...${NC}"
rm -f *.gem

# Build and test
echo -e "\n${GREEN}Running tests...${NC}"
bundle exec rake spec

# Build gem
echo -e "\n${GREEN}Building gem...${NC}"
gem build git_oops.gemspec

# Handle git tag
echo -e "\n${GREEN}Handling git tag v0.1.0...${NC}"
if [ "$FORCE" = true ]; then
  echo "Removing existing tag v0.1.0..."
  git tag -d v0.1.0 2>/dev/null || true
  git push origin :refs/tags/v0.1.0 2>/dev/null || true
fi

git tag -a "v0.1.0" -m "First release version 0.1.0"
git push origin "v0.1.0"

# Check if user has RubyGems credentials
if ! gem owner git_oops &>/dev/null; then
  echo -e "\n${YELLOW}You need to sign in to RubyGems to publish the gem.${NC}"
  if [ -z "$OTP_CODE" ]; then
    echo -e "Please run: ${GREEN}gem signin --otp [your_code]${NC}"
    echo -e "Or run this script with: ${GREEN}bin/first_release --otp [your_code]${NC}"
    exit 1
  else
    echo -e "\n${GREEN}Signing in to RubyGems with OTP...${NC}"
    gem signin --otp "$OTP_CODE"
  fi
fi

# Publish to RubyGems
echo -e "\n${GREEN}Publishing to RubyGems...${NC}"
if [ -n "$OTP_CODE" ]; then
  gem push "git_oops-0.1.0.gem" --otp "$OTP_CODE"
else
  gem push "git_oops-0.1.0.gem"
fi

# Cleanup
echo -e "\n${GREEN}Cleaning up...${NC}"
rm "git_oops-0.1.0.gem"

echo -e "\n${GREEN}First release v0.1.0 completed successfully!${NC}"
echo -e "\nNext steps:"
echo -e "1. Update CHANGELOG.md"
echo -e "2. Push changes to GitHub: ${GREEN}git push origin main${NC}"
